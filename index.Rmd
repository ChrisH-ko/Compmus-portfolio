---
title: "My Portfolio"
author: "Chris"
date: "2024-02-21"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    theme: sandstone
---

```{r setup, include=FALSE}
remotes::install_github('jaburgoyne/compmus')

library(tidyverse)
library(spotifyr)
library(compmus)
library(cowplot)
library(plotly)
```


```{r corpus, include=FALSE, cache=TRUE}
lettberg <- get_playlist_audio_features("", "3sdlcRjy5BTP7n3wYAv9SM") %>%
    mutate(sonata = as.numeric(gsub(".*?([0-9]+).*", "\\1", track.name))) %>%
  mutate(pianist = "Maria Lettberg")

ashkenazy <- get_playlist_audio_features("", "7bWfdaHsWluY72lP03tmBm") %>%
    mutate(sonata = as.numeric(gsub(".*?([0-9]+).*", "\\1", track.name))) %>%
    mutate(sonata = replace(sonata, sonata == 19, 2)) %>%
    mutate(pianist = "Vladimir Ashkenazy")

alexeev <- get_playlist_audio_features("", "06t6MgQ4xonM7npcnVNrRp") %>%
    mutate(sonata = as.numeric(gsub(".*?([0-9]+).*", "\\1", track.name))) %>%
    mutate(pianist = "Dmitri Alexeev")

zhukov <- get_playlist_audio_features("", "5EpGR6eUJkYDebReri1zdN") %>%
    mutate(sonata = as.numeric(gsub(".*?([0-9]+).*", "\\1", track.name))) %>%
    mutate(pianist = "Igor Zhukov")

pianists <- list(lettberg, ashkenazy, alexeev, zhukov)
all_recordings <- bind_rows(pianists) %>%
    mutate(period = replace(sonata, sonata < 11, "Late")) %>%
    mutate(period = replace(period, sonata < 6, "Middle")) %>%
    mutate(period = replace(period, sonata < 4, "Early"))
```


### The style of Scriabin 

There are many composers who have made a name for themselves when it comes to their contribution to the piano repertoire. One such composer is Alexander Scriabin. However, what seperates him from other composers of similar regard, is the way in which his musical language has developed throughout his life. The influence of Frederic Chopin and other romantic composers can clearly be discerned at the start of his carreer. In spite of that, his music would increasingly veer away from traditional harmony and tonality over the turn of the 20th century. Much like Arnold Schoenberg, he had developed a unique, modernist style of music that would influence many other 20th century composers.

One of my goals is to examine wether Scriabin's changing style could be accurately represented. This development is perhaps best reflected in Scriabin's 10 piano sonatas, which span the majority of his composing carreer. My corpus therefore consists of recordings of these sonatas by four pianists, namely Vladimir Ashkenazy, Maria Lettberg, Igor Zhukov and Dmitri Alexeev. These pieces, much like his other works, leave the performer with room for their own interpretation. So It would perhaps also be interesting to see in what capacity spotify could measure the difference between performers.

When considering tracks of particular interest, the 4th and 5th piano sonatas come to mind. The former being one of his first pieces to display a concrete change in style, and the later being one of the first stepts into truly new territory. Yet despite their differences they do both have a distinct touch of lightness that is in my opinion more difficult to find in his other sonatas. A further look into these pieces may yield intriguing results.

### Comparing the energy and valence for all sonatas

```{r Energy_valence}
all_recordings_mean_energy_valence <- all_recordings %>%
  group_by(pianist, period, sonata) %>%
  summarize(meanEnergy = mean(energy),
            meanValence = mean(valence))

zhukov_mean_energy_valence <- all_recordings_mean_energy_valence %>%
  filter(pianist == "Igor Zhukov")

zhukov_plot <- ggplot(zhukov_mean_energy_valence, aes(x = meanEnergy, y = meanValence, color=factor(period, levels=c("Early", "Middle", "Late")),)) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_grey(start = 0.75, end = 0) +
  labs(x="Energy", y="Valence", color="Period", title="Energy and Valence for Scriabin's 10 sonatas",
       subtitle="Igor Zhukov | The late sonatas have a distinctly low valence level.") +
  annotate("rect", xmin = 0.065, xmax = 0.15, ymin = 0.028, ymax = 0.038,
  alpha = .2) +
  annotate(
    "text",
    x = 0.1, y = 0.04,
    label = "Scriabin's late sonatas",
    vjust = 1, size = 5, color = "grey40"
  ) +
  annotate(
    "curve",
    x = 0.175, y = 0.028,
    xend = 0.155, yend = 0.033,
    arrow = arrow(length = unit(0.15, "cm"), type = "closed"),
    color = "grey40"
  ) +
  theme(legend.position = "none")

ggplotly(zhukov_plot)
```

***

This plot displays the valence and energy levels of the sonatas performed by Igor Zhukov, just as an example. If you focus on the valence feature, valence being a measure of positiveness, you might notice that while the differences accross sonatas are small, all the late sonatas seem to lay at a distinct valence level compared to the rest.

Those familiar with the music in question might not be suprised by this. These pieces are very representative of Scriabin's changing musical style, despite the fact that they are individually still unique. 


### The late sonatas contain similar valence levels accros all performers

```{r Energy_Valence_all}
energy_valence_plot <- ggplot(all_recordings_mean_energy_valence, aes(x = meanEnergy, y = meanValence, color=factor(period, levels=c("Early", "Middle", "Late")),)) +
  geom_point() +
  facet_wrap(~ pianist) +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_grey(start = 0.75, end = 0) +
  labs(x="Energy", y="Valence", color="Period", title="Energy and Valence for Scriabin's 10 sonatas",
       subtitle="The late sonatas have a distinctly low valence level.")

ggplotly(energy_valence_plot)
```

***

here you can see the previous results extend very well to other pianists and their recordings. While the energy and valence levels of the early and middle period of Scriabin's works vary quite a bit, the late sonatas all fall on the same range of valence, even across different performers.

At the same time however, the pieces show somewhat of a variance in energy levels across performers. This could perhaps reflect the natural room for interpretation of Scriabin's works, albeit this is hard to say from just this data.

### How clearly does a chromagram show a sonata's key?

```{r sonata_4_5, include=FALSE}
ashkenazy_4_1 <-
  get_tidy_audio_analysis("2NC2ht5e193dy3gNTIJdud") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(movement = 1)

ashkenazy_4_2 <-
  get_tidy_audio_analysis("4zRZaerPMAAtb3Ys5rGE54") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(movement = 2,
         start = start + tail(ashkenazy_4_1, n=1)$start)

ashkenazy_4 <- bind_rows(list(ashkenazy_4_1, ashkenazy_4_2)) %>%
    mutate(sonata = "Sonata 4")

ashkenazy_5 <-
  get_tidy_audio_analysis("4Au7Ih5wFRc0LZ9sMoT9Z3") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 5")
```


```{r Chromagram_4_and_5}
ashkenazy_4_chroma <- ashkenazy_4 |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma()

ashkenazy_5_chroma <- ashkenazy_5 |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma()

ashkenazy_4_5 <- ggplot(bind_rows(list(ashkenazy_4_chroma, ashkenazy_5_chroma)),
                            aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  facet_wrap(~ sonata, dir = "v", scales = "free_x") +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Chromagram of the 4th and 5th sonata", subtitle = "Vladimir Ashkenazy") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_4_5
```

***
Throughout Scriabin's carreer as a composer, you can quite clearly hear how his music starts getting more and more tonally ambiguous. Even to the point where it might not make much sense to discuss it in terms of tonality.

Take the following chromagrams of the 4th and 5th sonata for example. It is not far fetched to say that Scriabin's music has changed the most between these pieces. As a result, you can, albeit without the most confidence, observe how this piece is in F#. The 5th sonata on the other hand does not display display a clear tonic like the previous one does, which makes sense upon giving it a listen.

### From the 5th sonata, each sonata's key starts getting more ambiguous

```{r load_ashkenazy, include=FALSE, cache=TRUE}
ashkenazy_2_1 <-
  get_tidy_audio_analysis("2vNz6dat4cjEJol2AoqIIt") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

ashkenazy_2_2 <-
  get_tidy_audio_analysis("6pHp6L7zlZDO5LClxp3pYN") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(start = start + tail(ashkenazy_2_1, n=1)$start)

ashkenazy_2 <- bind_rows(list(ashkenazy_2_1, ashkenazy_2_2)) %>%
  mutate(sonata = "Sonata 2") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 2") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_4_chroma <- ashkenazy_4_chroma |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 4") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_6 <-
  get_tidy_audio_analysis("0NaVN5lDbMkmSwxSiAXMVc") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 6") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 6") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_8 <-
  get_tidy_audio_analysis("5RKOyVBXa05wImhToOBPcq") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 8") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 8") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_10 <-
  get_tidy_audio_analysis("27H4M1wOVah2qqHq5xbkeM") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 10") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 10") +
  theme_minimal() +
  scale_fill_viridis_c()

chroma_ashkenazy <- list(ashkenazy_2, ashkenazy_4_chroma, ashkenazy_6, ashkenazy_8, ashkenazy_10)

```


```{r Chromagram_ashkenazy, fig.height=16, fig.width=10}
plot_grid(plotlist = chroma_ashkenazy, ncol = 1)
```

***
Here are a couple more chromagrams. Let's look at a couple more pieces, once again performed by Vladimir Ashkenazy just for an example.

<br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br>

### Aligning different performances

```{r DTW, cache=TRUE}
lettberg_5 <-
  get_tidy_audio_analysis("0bCTqxYSyYP7OawV9cam1V") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

DTW_plot <- compmus_long_distance(
  ashkenazy_5 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  lettberg_5 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Vladimir Ashkenazy", y = "Maria Lettberg", title = "Sonata 5") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

DTW_plot
```

***
Text.

### Timbre analysis

```{r}
bzt <-
  get_tidy_audio_analysis("7GfFMPRWzHVQ2siD16SIgZ") |> # Change URI.
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  )
```

```{r}
bzt |>
  compmus_gather_timbre() |>
  ggplot(
    aes(
      x = start + duration / 2,
      width = duration,
      y = basis,
      fill = value
    )
  ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  scale_fill_viridis_c() +                              
  theme_classic()
```

***
text.

### Self similarity

```{r}
bzt |>
  compmus_self_similarity(pitches, "cosine") |> 
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_fixed() +
  scale_fill_viridis_c(guide = "none") +
  theme_classic() +
  labs(x = "", y = "")
```

***
Text.


