---
title: "My Portfolio"
author: "Chris"
date: "2024-02-21"
output: 
  flexdashboard::flex_dashboard:
    storyboard: true
    css: stylesheets/style.css
---

```{r setup, include=FALSE}
remotes::install_github('jaburgoyne/compmus')

library(tidyverse)
library(spotifyr)
library(compmus)
library(cowplot)
library(plotly)
```

```{r corpus, include=FALSE, cache=TRUE}
lettberg <- readRDS(file = "data/playlists/lettberg-playlist.RDS") |> add_audio_analysis()
ashkenazy <- readRDS(file = "data/playlists/ashkenazy-playlist.RDS") |> add_audio_analysis()
alexeev <- readRDS(file = "data/playlists/alexeev-playlist.RDS") |> add_audio_analysis()
zhukov <- readRDS(file = "data/playlists/zhukov-playlist.RDS") |> add_audio_analysis()

pianists <- list(lettberg, ashkenazy, alexeev, zhukov)
all_recordings <- bind_rows(pianists) %>%
    mutate(period = replace(sonata, sonata < 11, "Late")) %>%
    mutate(period = replace(period, sonata < 6, "Middle")) %>%
    mutate(period = replace(period, sonata < 4, "Early")) %>%
    mutate(period = factor(period, levels=c("Early", "Middle", "Late")))
```

```{r functions_chromagram, include=FALSE}
chroma_preprocessing <- function(sonata) {
  sonata <- sonata |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)
}

chromagram <- function(sonata, chroma) {
  if (chroma) {
    plot <- ggplot(sonata,
         aes(x = start + duration / 2,
            width = duration,
            y = pitch_class,
            fill = value
            )
        )
  } else {
    plot <- ggplot(sonata,
         aes(x = start + duration / 2,
            width = duration,
            y = basis,
            fill = value
            )
        )
  }
  
  plot +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude") +
  theme_classic() +
  scale_fill_viridis_c() +
  scale_x_continuous(breaks=seq(0,2000,60))
}
```

```{r}
cols <- c("Early" = "#c2df23", "Middle" = "#1fa187", "Late" = "#440154")
pitch_classes <- c("C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B")
```

### Spotify is not very certain about the late sonata's keys
```{r, cache=TRUE}
all_recordings %>%
  mutate(key_name = factor(key_name, levels = pitch_classes)) %>%
  filter(sonata >= 5, 
         movement == 1) %>%
  ggplot(aes(alpha = key_confidence, x = key_name, fill = pianist)) +
  geom_bar() +
  scale_fill_viridis_d() +
  scale_alpha(range=c(0.15, 1)) +
  facet_wrap(~ sonata, nrow = 2) + 
  labs(title = "Spotify key analysis", y = "", fill = "pianist", alpha = "confidence") +
  scale_x_discrete("Key", drop=FALSE)
```

***
Taking a look at the later half of Scriabin's sonatas, it quickly becomes clear that spotify has a harder time finding a key to stick with. Perhaps not unexpectedly so, since these pieces do not adhere to traditional tonality, as mentioned. While there might not be much of a point to trying to identify a key in these pieces, not to mention how spotify's analysis is probably not the best fit for unconventional music in general, it's still interesting to see how it even fails to agree on a pitch across different recordings.

Perhaps different pianists might naturally bring forward different pitches throughout these kinds of pieces, consciously or not. Or perhaps this is a result of the recording process, where different equipment, studios and 'finishing touches' might alter the pitch content of a recording.

On top of that, the key confidence feature also shows that spotify itself is aware of its uncertainty to some degree.

### Tonality is identifyable in early works...
```{r chord_masks, include=FALSE}
circshift <- function(v, n) {
  if (n == 0) v else c(tail(v, n), head(v, -n))
}

#      C     C#    D     Eb    E     F     F#    G     Ab    A     Bb    B
major_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    0,    0)
minor_chord <-
  c(   1,    0,    0,    1,    0,    0,    0,    1,    0,    0,    0,    0)
seventh_chord <-
  c(   1,    0,    0,    0,    1,    0,    0,    1,    0,    0,    1,    0)

major_key <-
  c(6.35, 2.23, 3.48, 2.33, 4.38, 4.09, 2.52, 5.19, 2.39, 3.66, 2.29, 2.88)
minor_key <-
  c(6.33, 2.68, 3.52, 5.38, 2.60, 3.53, 2.54, 4.75, 3.98, 2.69, 3.34, 3.17)

augmented_scale <-
  c(6, 0, 0, 1, 1, 0, 0, 1, 1, 0, 0, 1)

prometheus_scale <-
  c(6, 0, 1, 0, 1, 0, 1, 0, 0, 1, 1, 0)

octatonic_scale <-
  c(6, 1, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0)

octatonic_scale2 <-
  c(6, 0, 1, 1, 0, 1, 1, 0, 1, 1, 0, 1)

chord_templates <-
  tribble(
    ~name, ~template,
    "Gb:7", circshift(seventh_chord, 6),
    "Gb:maj", circshift(major_chord, 6),
    "Bb:min", circshift(minor_chord, 10),
    "Db:maj", circshift(major_chord, 1),
    "F:min", circshift(minor_chord, 5),
    "Ab:7", circshift(seventh_chord, 8),
    "Ab:maj", circshift(major_chord, 8),
    "C:min", circshift(minor_chord, 0),
    "Eb:7", circshift(seventh_chord, 3),
    "Eb:maj", circshift(major_chord, 3),
    "G:min", circshift(minor_chord, 7),
    "Bb:7", circshift(seventh_chord, 10),
    "Bb:maj", circshift(major_chord, 10),
    "D:min", circshift(minor_chord, 2),
    "F:7", circshift(seventh_chord, 5),
    "F:maj", circshift(major_chord, 5),
    "A:min", circshift(minor_chord, 9),
    "C:7", circshift(seventh_chord, 0),
    "C:maj", circshift(major_chord, 0),
    "E:min", circshift(minor_chord, 4),
    "G:7", circshift(seventh_chord, 7),
    "G:maj", circshift(major_chord, 7),
    "B:min", circshift(minor_chord, 11),
    "D:7", circshift(seventh_chord, 2),
    "D:maj", circshift(major_chord, 2),
    "F#:min", circshift(minor_chord, 6),
    "A:7", circshift(seventh_chord, 9),
    "A:maj", circshift(major_chord, 9),
    "C#:min", circshift(minor_chord, 1),
    "E:7", circshift(seventh_chord, 4),
    "E:maj", circshift(major_chord, 4),
    "G#:min", circshift(minor_chord, 8),
    "B:7", circshift(seventh_chord, 11),
    "B:maj", circshift(major_chord, 11),
    "D#:min", circshift(minor_chord, 3)
  )

key_templates <-
  tribble(
    ~name, ~template,
    "Gb:maj", circshift(major_key, 6),
    "Bb:min", circshift(minor_key, 10),
    "Db:maj", circshift(major_key, 1),
    "F:min", circshift(minor_key, 5),
    "Ab:maj", circshift(major_key, 8),
    "C:min", circshift(minor_key, 0),
    "Eb:maj", circshift(major_key, 3),
    "G:min", circshift(minor_key, 7),
    "Bb:maj", circshift(major_key, 10),
    "D:min", circshift(minor_key, 2),
    "F:maj", circshift(major_key, 5),
    "A:min", circshift(minor_key, 9),
    "C:maj", circshift(major_key, 0),
    "E:min", circshift(minor_key, 4),
    "G:maj", circshift(major_key, 7),
    "B:min", circshift(minor_key, 11),
    "D:maj", circshift(major_key, 2),
    "F#:min", circshift(minor_key, 6),
    "A:maj", circshift(major_key, 9),
    "C#:min", circshift(minor_key, 1),
    "E:maj", circshift(major_key, 4),
    "G#:min", circshift(minor_key, 8),
    "B:maj", circshift(major_key, 11),
    "D#:min", circshift(minor_key, 3)
  )
c_o_5 <-
  list("Gb", "Dd", "Ab", "Eb", "Bb", "F", "C", "G", "D", "A", "E", "B")

augmented_keys <-
  tribble(~name, ~template,
          "0", circshift(augmented_scale, 6))

prometheus_keys <-
  tribble(~name, ~template,
          paste("mystic", c_o_5[1]), circshift(prometheus_scale, 6))

octatonic_keys <-
  tribble(~name, ~template,
          # paste("octatonic 1", c_o_5[1]), circshift(octatonic_scale, 6),
          paste("octatonic", c_o_5[1]), circshift(octatonic_scale2, 6))

p_n_o <- bind_rows(prometheus_keys, octatonic_keys)

for (i in 2:12) {
  j <- (6 + 7 * (i-1)) %% 12
  key_a <-
  tribble(~name, ~template,
          c_o_5[[i]], circshift(augmented_scale, j))
  
  augmented_keys <- bind_rows(augmented_keys, key_a)
  
  key_p <-
  tribble(~name, ~template,
          paste("mystic", c_o_5[i]), circshift(prometheus_scale, j))
  
  prometheus_keys <- bind_rows(prometheus_keys, key_p)
  
  key_01 <-
  tribble(~name, ~template,
          paste("octatonic 1", c_o_5[i]), circshift(octatonic_scale, j))

  key_02 <-
  tribble(~name, ~template,
          paste("octatonic", c_o_5[i]), circshift(octatonic_scale2, j))
  
  octatonic_keys <- bind_rows(octatonic_keys,
                              #key_01,
                              key_02)
  
  p_n_o <- bind_rows(p_n_o, key_p, key_01, key_02)
}
```

```{r functions}
chord_pitches <- function(sonata) {
  sonata <- sonata |>
  compmus_align(bars, segments) |>
  select(bars) |>
  unnest(bars) |>
  mutate(group = row_number() %/% 4) |>
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"
      )
  ) %>%
  group_by(group) %>%
  mutate(pitches = list(colMeans(do.call(rbind, pitches))))
}

plot_key_chords <- function(sonata, template) {
  templates <- list(octatonic = octatonic_keys,
                 normal_key = key_templates)
  
  sonata |> 
  compmus_match_pitch_template(
    templates[[pmatch(template, names(templates))]],         # Change to chord_templates if descired
    method = "angular",  # Try different distance metrics
    norm = "euclidean"     # Try different norms
  ) |>
  ggplot(
    aes(x = start + duration / 2, width = duration, y = name, fill = d)
  ) +
  geom_tile() +
  scale_fill_viridis_c(guide = "none",
                       direction = -1,
                       trans = 'log'
    ) +
  theme_minimal() +
  labs(x = "Time (s)", y = "") +
  scale_x_continuous(breaks=seq(0,2000,60))
}
```

```{r}
zhukov_2_1 <- zhukov %>%
  filter(sonata == 2,
         movement == 1) %>%
  chord_pitches()

zhukov_9_1 <- zhukov %>%
  filter(sonata == 9) %>%
  chord_pitches()
```

```{r}
key_2_1 <- plot_key_chords(zhukov_2_1, "normal_key") +
  labs(title = "Keygram | sonata 2, mvt. 1", subtitle = "Igor Zhukov") +
  geom_vline(xintercept = 235, colour = "#c2abab", size = 0.8) +
  geom_vline(xintercept = 320, colour = "#c2abab", size = 0.8)
key_2_1
```

***
```{=html}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/0zKZR4PiuC60TpDRo9VWWZ?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" data-external="1"></iframe>
```

We can use a recording's pitch content to try and estimate its key and which chords appear in it. An example of this can be seen here for the first movement of the second sonata in G# minor. This piece can quite easily be described in sonata form, with the exposition starting in G# minor as expected, briefly going to D# minor before largely remaining in B major.

The development section continues in B major, before quickly and briefly shifting to D major, G minor, C minor, F minor and eventually leads back to G# minor. The recapitulation continues on in G# minor, before quickly modulating to the relative E major and remaining there until the end of the movement.

These key changes are reflected quite well in the keygram, although it certainly helps to know them beforehand.

### What about the later sonatas?
```{r}
key_9_1 <- plot_key_chords(zhukov_9_1, "octatonic") +
  labs(title = "Keygram | sonata 9", subtitle = "Igor Zhukov")
key_9_1
```

***
```{=html}
<iframe style="border-radius:12px" src="https://open.spotify.com/embed/track/70LZoLXVyBcbaMKDaSNvAn?utm_source=generator&theme=0" width="100%" height="352" frameBorder="0" allowfullscreen="" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy" data-external="1"></iframe>
```

There's a lot that can be said about Scriabin's harmonic language. One important aspect of his later works is how, to a fair extent, it's based on unique scales and chords such as the [octatonic scale](https://en.wikipedia.org/wiki/Octatonic_scale) or the ['mystic' chord](https://en.wikipedia.org/wiki/Mystic_chord). I've tried to create a mask of one of the organizations of the octatonic scale for each pitch class to see if it may yield interesting results for the 9th sonata.

### A piece's tempo can vary quite a bit accross pianists
```{r}
all_recordings |>
  mutate(
    sections =
      map(
        sections,                                    # sections or segments
        summarise_at,
        vars(tempo, loudness, duration),             # features of interest
        list(section_mean = mean, section_sd = sd)   # aggregation functions
      )
  ) |>
  unnest(sections) |>
  ggplot(
    aes(
      x = tempo,
      y = tempo_section_sd,
      colour = period,
      alpha = loudness
    )
  ) +
  geom_point(aes(size = duration / 60)) +
  geom_rug() +
  theme_minimal() +
  labs(
    x = "Mean Tempo (bpm)",
    y = "SD Tempo",
    colour = "Genre",
    size = "Duration (min)",
    alpha = "Volume (dBFS)"
  ) + 
  facet_wrap(~ pianist) +
  scale_color_manual(values = cols)
```

***
text.


### The style of Scriabin 

There are many composers who have made a name for themselves when it comes to their contribution to the piano repertoire. One such composer is Alexander Scriabin. However, what seperates him from other composers of similar regard, is the way in which his musical language has developed throughout his life. The influence of Frederic Chopin and other romantic composers can clearly be discerned at the start of his carreer. In spite of that, his music would increasingly veer away from traditional harmony and tonality over the turn of the 20th century. Much like Arnold Schoenberg, he had developed a unique, modernist style of music that would influence many other 20th century composers.

One of my goals is to examine wether Scriabin's changing style could be accurately represented. This development is perhaps best reflected in Scriabin's 10 piano sonatas, which span the majority of his composing carreer. My corpus therefore consists of recordings of these sonatas by four pianists, namely Vladimir Ashkenazy, Maria Lettberg, Igor Zhukov and Dmitri Alexeev. These pieces, much like his other works, leave the performer with room for their own interpretation. So It would perhaps also be interesting to see in what capacity spotify could measure the difference between performers.

When considering tracks of particular interest, the 4th and 5th piano sonatas come to mind. The former being one of his first pieces to display a concrete change in style, and the later being one of the first stepts into truly new territory. Yet despite their differences they do both have a distinct touch of lightness that is in my opinion more difficult to find in his other sonatas. A further look into these pieces may yield intriguing results.

### Comparing the energy and valence for all sonatas

```{r Energy_valence}
all_recordings_mean_energy_valence <- all_recordings %>%
  group_by(pianist, period, sonata) %>%
  summarize(mean_energy = mean(energy),
            mean_valence = mean(valence),
            period = factor(period, levels=c("Early", "Middle", "Late")))

zhukov_mean_energy_valence <- all_recordings_mean_energy_valence %>%
  filter(pianist == "Igor Zhukov")

cols <- c("Early" = "#c2df23", "Middle" = "#1fa187", "Late" = "#440154")

zhukov_plot <- ggplot(zhukov_mean_energy_valence, aes(x = mean_energy, y = mean_valence, color= period)) +
  annotate("rect", xmin = 0.065, xmax = 0.15, ymin = 0.028, ymax = 0.038, alpha = .2) +
  geom_point() +
  scale_y_log10() +
  scale_x_log10() +
  # scale_color_grey(start = 0.75, end = 0) +
  labs(x="Energy", y="Valence", color="Period", title="Energy and Valence for Scriabin's 10 sonatas",
       subtitle="Igor Zhukov | The late sonatas have a distinctly low valence level.") +
  annotate(
    "text",
    x = 0.1, y = 0.04,
    label = "Scriabin's late sonatas",
    vjust = 1, size = 5, color = "grey40"
  ) +
  scale_color_manual(values = cols)

ggplotly(zhukov_plot)
```

***

This plot displays the valence and energy levels of the sonatas performed by Igor Zhukov, just as an example. If you focus on the valence feature, valence being a measure of positiveness, you might notice that while the differences accross sonatas are small, all the late sonatas seem to lay at a distinct valence level compared to the rest.

Those familiar with the music in question might not be suprised by this. These pieces are very representative of Scriabin's changing musical style, despite the fact that they are individually still unique. 


### The late sonatas contain similar valence levels accros all performers

```{r Energy_Valence_all}
energy_valence_plot <- ggplot(all_recordings_mean_energy_valence, aes(x = mean_energy, y = mean_valence, color= period)) +
  geom_point() +
  facet_wrap(~ pianist) +
  scale_y_log10() +
  scale_x_log10() +
  scale_color_manual(values = cols) +
  labs(x="Energy", y="Valence", color="Period", title="Energy and Valence for Scriabin's 10 sonatas",
       subtitle="The late sonatas have a distinctly low valence level.")

ggplotly(energy_valence_plot)
```

***

here you can see the previous results extend very well to other pianists and their recordings. While the energy and valence levels of the early and middle period of Scriabin's works vary quite a bit, the late sonatas all fall on the same range of valence, even across different performers.

At the same time however, the pieces show somewhat of a variance in energy levels across performers. This could perhaps reflect the natural room for interpretation of Scriabin's works, albeit this is hard to say from just this data.

### How clearly does a chromagram show a sonata's key?

```{r get_sonatas_chromagram, include=FALSE}
ashkenazy_4_1 <- readRDS(file = "data/pieces/ashkenazy/ashkenazy_4_1.RDS")
ashkenazy_4_2 <- readRDS(file = "data/pieces/ashkenazy/ashkenazy_4_2.RDS")
ashkenazy_5 <- readRDS(file = "data/pieces/ashkenazy/ashkenazy_5_1.RDS")

chroma_comparison <- list(ashkenazy_4_1,
                          ashkenazy_4_2,
                          ashkenazy_5)

chroma_comparison <- lapply(chroma_comparison, chroma_preprocessing)
```

```{r process_4_5, include=FALSE}
ashkenazy_4_1_chroma <- chroma_comparison[[1]] %>%
  mutate(movement = 1)

ashkenazy_4_2_chroma <- chroma_comparison[[2]] %>%
  mutate(movement = 2,
         start = start + tail(ashkenazy_4_1_chroma, n=1)$start)

ashkenazy_4_pitches <- bind_rows(list(ashkenazy_4_1_chroma, ashkenazy_4_2_chroma)) %>%
    mutate(sonata = "Sonata 4")

ashkenazy_5_pitches <- chroma_comparison[[3]] %>%
  mutate(sonata = "Sonata 5")
```

```{r Chromagram_4_5}
ashkenazy_4_chroma <- ashkenazy_4_pitches |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma()

ashkenazy_5_chroma <- ashkenazy_5_pitches |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma()


chromagram_ashk_4 <- chromagram(ashkenazy_4_chroma, TRUE) +
    labs(title = "Chromagram of the 4th sonata", subtitle = "Vladimir Ashkenazy") +
    geom_vline(xintercept = head(ashkenazy_4_2_chroma, n=1)$start, colour = "red")

chromagram_ashk_5 <- chromagram(ashkenazy_5_chroma, TRUE) +
    labs(title = "Chromagram of the 5th sonata", subtitle = "Vladimir Ashkenazy")

chromagram_ashk_4_5 <- list(chromagram_ashk_4, chromagram_ashk_5)

plot_grid(plotlist = chromagram_ashk_4_5, ncol = 1)
```

***
Throughout Scriabin's carreer as a composer, you can quite clearly hear how his music starts getting more and more tonally ambiguous. Even to the point where it might not make much sense to discuss it in terms of tonality.

Take the following chromagrams of the 4th and 5th sonata for example. It is not far fetched to say that Scriabin's music has changed the most between these pieces. As a result, you can, albeit without the most confidence, observe how this piece is in F#. The 5th sonata on the other hand does not display display a clear tonic like the previous one does, which makes sense upon giving it a listen.

### From the 5th sonata, each sonata's key starts getting more ambiguous

```{r load_ashkenazy, include=FALSE, cache=TRUE}
ashkenazy_2_1 <-
  get_tidy_audio_analysis("2vNz6dat4cjEJol2AoqIIt") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

ashkenazy_2_2 <-
  get_tidy_audio_analysis("6pHp6L7zlZDO5LClxp3pYN") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(start = start + tail(ashkenazy_2_1, n=1)$start)

ashkenazy_2 <- bind_rows(list(ashkenazy_2_1, ashkenazy_2_2)) %>%
  mutate(sonata = "Sonata 2") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 2") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_4_chroma <- ashkenazy_4_chroma |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 4") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_6 <-
  get_tidy_audio_analysis("0NaVN5lDbMkmSwxSiAXMVc") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 6") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 6") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_8 <-
  get_tidy_audio_analysis("5RKOyVBXa05wImhToOBPcq") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 8") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 8") +
  theme_minimal() +
  scale_fill_viridis_c()

ashkenazy_10 <-
  get_tidy_audio_analysis("27H4M1wOVah2qqHq5xbkeM") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches) %>%
  mutate(sonata = "Sonata 10") |>
  mutate(pitches = map(pitches, compmus_normalise, "euclidean")) |>
  compmus_gather_chroma() |>
  ggplot(aes(
      x = start + duration / 2,
      width = duration,
      y = pitch_class,
      fill = value
    )
    ) +
  geom_tile() +
  labs(x = "Time (s)", y = NULL, fill = "Magnitude", title = "Sonata 10") +
  theme_minimal() +
  scale_fill_viridis_c()

chroma_ashkenazy <- list(ashkenazy_2, ashkenazy_4_chroma, ashkenazy_6, ashkenazy_8, ashkenazy_10)

```

```{r Chromagram_ashkenazy, fig.height=16, fig.width=10}
plot_grid(plotlist = chroma_ashkenazy, ncol = 1)
```

***
Here are a couple more chromagrams. Let's look at a couple more pieces, once again performed by Vladimir Ashkenazy just for an example.

<br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br> <br>

### Aligning different performances

```{r DTW, cache=TRUE}
lettberg_5 <-
  get_tidy_audio_analysis("0bCTqxYSyYP7OawV9cam1V") |>
  select(segments) |>
  unnest(segments) |>
  select(start, duration, pitches)

DTW_plot <- compmus_long_distance(
  ashkenazy_5_pitches |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  lettberg_5 |> mutate(pitches = map(pitches, compmus_normalise, "chebyshev")),
  feature = pitches,
  method = "euclidean"
) |>
  ggplot(
    aes(
      x = xstart + xduration / 2,
      width = xduration,
      y = ystart + yduration / 2,
      height = yduration,
      fill = d
    )
  ) +
  geom_tile() +
  coord_equal() +
  labs(x = "Vladimir Ashkenazy", y = "Maria Lettberg", title = "Sonata 5") +
  theme_minimal() +
  scale_fill_viridis_c(guide = NULL)

DTW_plot
```

***
Text.


### It is difficult to gather much information out of timbre

```{r  self_similarity, include=FALSE}
lettberg_1_1 <- readRDS(file = "data/pieces/lettberg/lettberg_1_1.RDS")
lettberg_2_1 <- readRDS(file = "data/pieces/lettberg/lettberg_2_1.RDS")
lettberg_3_1 <- readRDS(file = "data/pieces/lettberg/lettberg_3_1.RDS")
lettberg_4_1 <- readRDS(file = "data/pieces/lettberg/lettberg_4_1.RDS")
lettberg_5_1 <- readRDS(file = "data/pieces/lettberg/lettberg_5_1.RDS")
lettberg_6_1 <- readRDS(file = "data/pieces/lettberg/lettberg_6_1.RDS")
lettberg_7_1 <- readRDS(file = "data/pieces/lettberg/lettberg_7_1.RDS")
lettberg_8_1 <- readRDS(file = "data/pieces/lettberg/lettberg_8_1.RDS")
lettberg_9_1 <- readRDS(file = "data/pieces/lettberg/lettberg_9_1.RDS")
lettberg_10_1 <- readRDS(file = "data/pieces/lettberg/lettberg_10_1.RDS")
```

```{r functions_timbre_selfsim, include=FALSE}
chroma_and_timbre <- function(sonata) {
  sonata <- sonata |>
  compmus_align(bars, segments) |>                     # Change `bars`
  select(bars) |>                                      #   in all three
  unnest(bars) |>                                      #   of these lines.
  mutate(
    pitches =
      map(segments,
        compmus_summarise, pitches,
        method = "rms", norm = "euclidean"              # Change summary & norm.
      )
  ) |>
  mutate(
    timbre =
      map(segments,
        compmus_summarise, timbre,
        method = "rms", norm = "euclidean"             # Change summary & norm.
      )
  )
}

self_similarity <- function(sonata, chroma) {
  if (chroma) {
    plot <- sonata |>
      compmus_self_similarity(pitches, "cosine") 
  } else {
    plot <- sonata |>
      compmus_self_similarity(timbre, "cosine") 
  }
  
  plot |> 
    ggplot(
      aes(
        x = xstart + xduration / 2,
        width = xduration,
        y = ystart + yduration / 2,
        height = yduration,
        fill = d
      )
    ) +
    geom_tile() +
    coord_fixed() +
    scale_fill_viridis_c(guide = "none") +
    theme_classic() +
    labs(x = "", y = "") +
    scale_x_continuous(breaks=seq(0,2000,60)) +
    scale_y_continuous(breaks=seq(0,2000,60)) +
    theme(axis.text.x = element_text(angle=-45))
}
```

```{r}
timbre_analysis <- list(lettberg_1_1,
                        lettberg_8_1)

timbre_analysis <- lapply(timbre_analysis, chroma_and_timbre)
```

```{r}
sonata_1 <- timbre_analysis[[1]]
sonata_8 <- timbre_analysis[[2]]


cep_1 <- sonata_1 |>
  compmus_gather_timbre() |>
  chromagram(chroma = FALSE) +
    geom_vline(xintercept = 151, colour = "red") +
    geom_vline(xintercept = 299, colour = "red") +
    labs(title = "Cepstrogram of the 1st sonata", subtitle = "Maria Lettberg")


cep_8 <- sonata_8 |>
  compmus_gather_timbre() |>
  chromagram(chroma = FALSE) +
  labs(title = "Cepstrogram of the 8th sonata", subtitle = "Maria Lettberg") +
  geom_vline(xintercept = 140, colour = "red")


plot_grid(plotlist = list(cep_1, cep_8), ncol = 1)
```

***
Similarly to the chromagrams, spotify also allows us to analyse the timbre content of the pieces, referred to as Cepstrograms.
However, solo piano works don't always lend themselves to this type of analysis, since you are generally limited in the kinds of timbres
you can create with just a piano, unless you start employing extended techniques like in [George Crumb's](https://youtu.be/pIEUS0-DDcs) case for instance. Regardless, there are instances where a pieces's eccentricities are reflected in its cepstrogram.

Consider a sonata's structure for example. One defining aspect of the sonata is how its first movement is composed in sonata form. Although like most musical conventions, composers have been straying from this practice over time, including Scriabin. Despite that, his first sonata does display a strong semblance of sonata form. When looking at the cepstrogram, you can make out how the exposition section is repeated once in the sonata's beginning.

Structural details like this are hard to find in his other sonatas, especially when only looking at pitch and timbre. It is quite tough to define an overarching structure in his 8th sonata for instance. Nevertheless, you can clearly see the first 2 minutes being distinct from the rest of the piece. Upon giving this sonata a listen, you'll notice that this section is noticeably unnerving yet tranquil.

### The structure of Scriabin's sonatas is not always easy to define

```{r}
timbre_analysis <- list(lettberg_2_1,
                        lettberg_7_1)

timbre_analysis <- lapply(timbre_analysis, chroma_and_timbre)

sonata_2 <- timbre_analysis[[1]]
sonata_7 <- timbre_analysis[[2]]
```

```{r}
selfsim_chroma_1 <- self_similarity(sonata_1, chroma=TRUE) +
  labs(title = "Pitch | Sonata No. 1", subtitle = "Maria Lettberg")
selfsim_timbre_1 <- self_similarity(sonata_1, chroma=FALSE) +
  labs(title = "Timbre | Sonata No. 1", subtitle = "Maria Lettberg")

plot_grid(plotlist = list(selfsim_chroma_1, selfsim_timbre_1)) + labs(title = "Self similarity matrices")
```

***
These plots display the pitch and timbre-based self-similarity within Scriabin's first sonata. While the Timbre matrix does not seem to divulge much, since the overall timbre of the piece does not vary much, you can still make out how there's one bar after around 150 seconds where there's a large pause. Other than that, the plot does not tell us much.

The pitch-based self-similarity matrix on the other hand does clearly display the repetition of the sonata's exposition. As seen in how there's a dark blue line parallel to the diagonal of the matrix, indicating that two different sections of the piece overlap. The development and recapitulation are a bit harder to make out. However if you look closely, you can just barely see a very short dark blue diagonal line starting at 420 seconds on the x axis. This line is very short since the recapitulation almost immediately modulates to a different key.

### Self-similarity matrices help very little with the later sonatas

```{r}
selfsim_chroma_7 <- self_similarity(sonata_7, chroma=TRUE) +
  labs(title = "Pitch | Sonata No. 7", subtitle = "Maria Lettberg")
selfsim_timbre_7 <- self_similarity(sonata_7, chroma=FALSE) +
  labs(title = "Timbre | Sonata No. 7", subtitle = "Maria Lettberg")

plot_grid(plotlist = list(selfsim_chroma_7, selfsim_timbre_7))
```

***
As Scriabin started breaking away from conventional late-romanticism, he also began applying structure to his pieces in a different way. Rather than repetition, Scriabin utilizes many different motifs that he transforms, combines, transposes and puts into different contexts. What then defines the different sections of these pieces is how these motifs are applied. Two sections might be related through a motif appearing in a similar context, despite being modulated, in a different register or altered. This makes it very difficult to find any meaning these self-similarity matrices, as the sonatas' structures are not defined by either pitch nor timbre. Not to mention how there's is little to go off of on timbre. Let alone how these pieces' actual structures are up to debate.

When specifically looking at the matrices of the seventh sonata, we can once more see instances of prolonged silence in the timbre matrix. This piece does follow some semblance of sonata form, however as expected it does not really show in either matrix. You can vaguely make out how the piece goes from one section to another at around 390 seconds in. The pitch matrix show that the material before and after that point are quite dissimilar. This matches up where one could consider the recapitulation of the sonata to be, since it sounds like a retelling of the beginning of the piece.
